{% extends "navbar.html" %}
{% block content %}
{% from "macros.html" import difficulty %}

<div class="w-full md:w-3/4 h-full">
    <form method="GET" action="/" id="filtersForm">
        <div class="flex gap-2 justify-center">
            <div class="flex items-center justify-center relative">
                <button id="dropdownDefaultButton" class="z-50 dropdownButton font-semibold text-white bg-blue-700 hover:bg-blue-800 rounded-lg px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
                    Difficulty
                    <svg id="dropdownArrow" class="ml-2 w-2.5 h-2.5 ms-3 transition-transform duration-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                    </svg>
                </button>
            
                <div id="dropdown" class="hidden w-36 mt-45 absolute z-40 opacity-0 scale-y-0 origin-top bg-white rounded-lg shadow dark:bg-neutral-800 transition-all duration-300 ease-in-out">
                    <label class="border-r-2 border-l-2 border-t-2 select-none block p-2 border-b rounded-t-lg hover:bg-gray-200 dark:hover:bg-neutral-700 transition dark:border-neutral-700">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 dark:border-neutral-800 rounded dark:bg-neutral-800 focus:outline-none" type="checkbox" name="difficulty" value="easy" {% if 'easy' in selected_difficulties %}checked{% endif %}> Easy
                    </label>
                    <label class="border-r-2 border-l-2 select-none block p-2 border-b hover:bg-gray-200 transition dark:hover:bg-neutral-700 dark:border-neutral-700">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 dark:border-neutral-800 rounded dark:bg-neutral-800 focus:outline-none" type="checkbox" name="difficulty" value="medium" {% if 'medium' in selected_difficulties %}checked{% endif %}> Medium
                    </label>
                    <label class="border-r-2 border-l-2 border-b-2 select-none block p-2 hover:bg-gray-200 transition dark:hover:bg-neutral-700 dark:border-neutral-700 rounded-b-lg">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded dark:bg-neutral-800 focus:outline-none" type="checkbox" name="difficulty" value="hard" {% if 'hard' in selected_difficulties %}checked{% endif %}> Hard
                    </label>
                </div>
            </div>
            
            <div class="flex items-center justify-center relative">
                <button id="dropdownPlatformButton" class="dropdownButton font-semibold text-white bg-blue-700 hover:bg-blue-800 rounded-lg px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
                    Platform
                    <svg id="dropdownArrowPlatform" class="ml-2 w-2.5 h-2.5 ms-3 transition-transform duration-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                    </svg>
                </button>
            
                <div id="dropdownPlatform" class="hidden w-36 mt-36 absolute z-50 opacity-0 scale-y-0 origin-top bg-white rounded-lg shadow dark:bg-neutral-800 transition-all duration-300 ease-in-out">
                    <label class="border-r-2 border-l-2 border-t-2 select-none block p-2 border-b rounded-t-lg hover:bg-gray-200 dark:hover:bg-neutral-700 transition dark:border-neutral-700">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 dark:border-neutral-800 rounded dark:bg-neutral-800 focus:outline-none" type="checkbox" name="platform" value="thm" {% if 'thm' in selected_platforms %}checked{% endif %}> TryHackMe
                    </label>
                    <label class="border-r-2 border-l-2 border-b-2 select-none block p-2 hover:bg-gray-200 transition dark:hover:bg-neutral-700 dark:border-neutral-700 rounded-b-lg">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded dark:bg-neutral-800 focus:outline-nonee" type="checkbox" name="platform" value="htb" {% if 'htb' in selected_platforms %}checked{% endif %}> Hack The Box
                    </label>
                </div>
            </div>
            

            <div class="flex items-center justify-center">
                <button data-dropdown="posted" class="dropdownButton font-semibold text-white bg-blue-700 hover:bg-blue-800 rounded-lg px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
                    Posted date
                    <svg class="ml-2 w-2.5 h-2.5 ms-3 transition-transform duration-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                    </svg>
                </button>
                
                <div id="dropdownSort" class="hidden w-36 mt-36 absolute z-50 opacity-0 scale-y-0 origin-top bg-white rounded-lg shadow dark:bg-neutral-800 transition-all duration-300 ease-in-out">
                    <label class="border-r-2 border-l-2 border-t-2 select-none block p-2 border-b rounded-t-lg hover:bg-gray-200 dark:hover:bg-neutral-700 transition dark:border-neutral-700">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 dark:border-neutral-800 rounded dark:bg-neutral-800 focus:outline-none" type="radio" name="posted" value="newest" {% if 'newest' == posted or posted is none %}checked{% endif %}> Newest
                    </label>
                    <label class="border-r-2 border-l-2 border-b-2 select-none block p-2 hover:bg-gray-200 transition dark:hover:bg-neutral-700 dark:border-neutral-700 rounded-b-lg">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 dark:border-neutral-800 rounded dark:bg-neutral-800 focus:outline-none" type="radio" name="posted" value="oldest" {% if 'oldest' == posted %}checked{% endif %}> Oldest
                    </label>
                </div>
            </div>

            <div class="flex items-center justify-center">
                <button data-dropdown="created" class="dropdownButton font-semibold text-white bg-blue-700 hover:bg-blue-800 rounded-lg px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
                    Creation date
                    <svg class="ml-2 w-2.5 h-2.5 ms-3 transition-transform duration-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                    </svg>
                </button>
                
                <div id="dropdownSort" class="hidden w-36 mt-36 absolute z-50 opacity-0 scale-y-0 origin-top bg-white rounded-lg shadow-xl dark:bg-neutral-800 transition-all duration-300 ease-in-out">
                    <label class="border-r-2 border-l-2 border-t-2 select-none block p-2 border-b rounded-t-lg hover:bg-gray-200 dark:hover:bg-neutral-700 transition dark:border-neutral-700">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 dark:border-neutral-800 rounded dark:bg-neutral-800 focus:outline-none" type="radio" name="created" value="newest" {% if 'newest' == created %}checked{% endif %}> Newest
                    </label>
                    <label class="border-r-2 border-l-2 border-b-2 select-none block p-2 hover:bg-gray-200 transition dark:hover:bg-neutral-700 dark:border-neutral-700 rounded-b-lg">
                        <input class="filter-checkbox focus:ring-0 focus:ring-offset-0 z-50 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 dark:border-neutral-800 rounded dark:bg-neutral-800 focus:outline-none" type="radio" name="created" value="oldest" {% if 'oldest' == created %}checked{% endif %}> Oldest
                    </label>
                </div>
            </div>
        </div>
    </form>       

    <div id="writeupsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 p-4 md:p-8">
        {% for writeup in writeups %}
        <div class="writeup transform transition ease-in-out hover:scale-105 duration-300 max-w-sm max-h-[500px]" data-difficulty="{{ writeup.difficulty }}">
            <a href="/writeup/{{writeup.url}}" class="dark:border-neutral-700 block bg-white border border-gray-200 rounded-lg shadow-xl hover:bg-gray-100 dark:bg-neutral-800 dark:hover:bg-neutral-700">
                <img class="pt-2 h-40 w-full object-contain rounded-t-lg md:rounded-none md:rounded-s-lg border-b dark:border-neutral-600" src="/static/writeups/{{writeup.url}}/logo.jpg" alt="">
                <div class="p-4 flex flex-col justify-between h-full">
                    <h5 class="text-xl font-medium text-gray-900 dark:text-white flex justify-between items-center truncate">
                        {{writeup.name}}
                    </h5>
                    <div class="truncate">
                        {{difficulty(writeup.difficulty, writeup.posted.strftime('%b %d, %Y')) }}
                    </div>
                    <p class="text-gray-700 dark:text-gray-400 truncate">{{writeup.description}}</p>
                </div>
            </a>    
        </div>
        {% endfor %}
    </div>

    <div class="flex justify-center mt-4">
        <button id="prevPage" class="hidden px-4 py-2 mx-2 text-white bg-blue-700 rounded">Previous</button>
        <button id="nextPage" class="hidden px-4 py-2 mx-2 text-white bg-blue-700 rounded">Next</button>
    </div>
</div>

<script>
    document.querySelectorAll('.dropdownButton').forEach(dropdownButton => {
        const dropdownMenu = dropdownButton.nextElementSibling;
        const dropdownArrow = dropdownButton.querySelector('svg');

        dropdownButton.addEventListener('click', (event) => {
            event.stopPropagation();
            
            if (dropdownMenu.classList.contains('hidden')) {
                closeAllDropdowns();

                dropdownMenu.classList.remove('hidden', 'opacity-0', 'scale-y-0');
                dropdownMenu.classList.add('opacity-100', 'scale-y-100');
                dropdownArrow.classList.add('rotate-180');
            } else {
                dropdownMenu.classList.add('hidden', 'opacity-0', 'scale-y-0');
                dropdownMenu.classList.remove('opacity-100', 'scale-y-100');
                dropdownArrow.classList.remove('rotate-180');
            }
        });
    });

    document.querySelectorAll('.dropdownButton ~ div').forEach(menu => {
        menu.addEventListener('click', (event) => {
            event.stopPropagation();
        });
    });

    document.addEventListener('click', () => {
        closeAllDropdowns();
    });

    function closeAllDropdowns() {
        document.querySelectorAll('.dropdownButton').forEach(button => {
            const dropdownMenu = button.nextElementSibling;
            const dropdownArrow = button.querySelector('svg');

            dropdownMenu.classList.add('hidden', 'opacity-0', 'scale-y-0');
            dropdownMenu.classList.remove('opacity-100', 'scale-y-100');
            dropdownArrow.classList.remove('rotate-180');
        });
    }

    let timeout;

    document.querySelectorAll('.filter-checkbox').forEach((checkbox) => {
        checkbox.addEventListener('change', () => {
            if (checkbox.name === 'difficulty' || checkbox.name === 'platform') {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    document.getElementById('filtersForm').submit();
                }, 1000);
            } else if (checkbox.name === 'posted' || checkbox.name === 'created') {
                document.getElementById('filtersForm').submit();
            }
        });
    });

    const writeups = Array.from(document.querySelectorAll('.writeup'));
    const filters = Array.from(document.querySelectorAll('.filter-checkbox'));
    const writeupsContainer = document.getElementById('writeupsContainer');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const itemsPerPage = 12;

    let currentPage = 0;

    function updatePagination() {
        const totalPages = Math.ceil(filteredWriteups.length / itemsPerPage);

        writeups.forEach(w => w.classList.add('hidden'));
        filteredWriteups.slice(currentPage * itemsPerPage, (currentPage + 1) * itemsPerPage)
            .forEach(w => w.classList.remove('hidden'));

        prevPage.style.display = currentPage > 0 ? 'inline-block' : 'none';
        nextPage.style.display = currentPage < totalPages - 1 ? 'inline-block' : 'none';
    }

    filters.forEach(filter => filter.addEventListener('change', () => {
        currentPage = 0;
        updatePagination();
    }));

    prevPage.addEventListener('click', () => {
        currentPage = Math.max(0, currentPage - 1);
        updatePagination();
    });

    nextPage.addEventListener('click', () => {
        currentPage++;
        updatePagination();
    });

    updatePagination();

</script>

{% endblock %}
